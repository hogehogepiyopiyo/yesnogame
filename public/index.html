<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yes/No ã‚¯ã‚¤ã‚º</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 10px;
      background: #ffffff; /* â† ç™½ã«æˆ»ã—ãŸ */
    }
    h1 {
      text-align: center;
      margin: 6px 0 10px;
    }
    #room-info {
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      background: #fff;
      border-radius: 6px;
    }
    #room-url {
      cursor: pointer;
      text-decoration: underline;
      word-break: break-all;
    }
    #name-area {
      margin: 10px 0;
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      background: #fff;
      border-radius: 6px;
    }
    #name-input {
      padding: 4px;
      font-size: 1rem;
      width: 200px;
      max-width: 100%;
    }
    #log {
      border: 1px solid #ccc;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      background: #fafafa;
      margin-bottom: 10px;
      white-space: pre-wrap;
      border-radius: 6px;
    }
    #log-toolbar {
      display: flex;
      flex-direction: column;   /* ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
      align-items: flex-end;    /* å³å¯„ã›ã«ã™ã‚‹ */
      margin-bottom: 4px;
      gap: 4px;                 /* ãƒœã‚¿ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã®ç¸¦ã®é–“éš” */
      font-size: 0.85rem;
    }

    .btn-copy {
      background: #eee8ff;
      border-color: #aa88ff;
    }
    .msg {
      margin-bottom: 6px;
      font-size: 0.95rem;
    }
    .msg-me {
      color: #0044aa; /* è‡ªåˆ†ï¼ˆé’ç³»ï¼‰ */
    }
    .msg-other {
      color: #aa6600; /* ä»–äººï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰ */
    }
    .msg-free {
      background: #fff8e1;           /* è–„ã„ã‚¯ãƒªãƒ¼ãƒ è‰²ã®èƒŒæ™¯ */
      border-left: 3px solid #ffb300;/* å·¦ã«é»„è‰²ã„ç·š */
      padding: 2px 4px;
      border-radius: 3px;
    }
    .msg-bot {
      color: #004422;
      background: #e5f5e5;
      border-left: 4px solid #66aa66;
      padding: 6px 8px;
      border-radius: 4px;
    }
    .bot-name {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .bot-body {
      font-size: 0.95rem;
    }
    .bot-line {
      margin: 1px 0;
    }
    .bot-tag-line {
      margin: 2px 0;
    }
    .bot-tag {
      display: inline-block;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 999px;
      margin-right: 6px;
      background: #ffffff;
      border: 1px solid #cccccc;
      vertical-align: middle;
    }
    .bot-tag-mvp {
      border-color: #e6a700;
    }
    .bot-tag-point {
      border-color: #0088cc;
    }
    .bot-tag-text {
      vertical-align: middle;
    }
    #form {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    #input {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
    }
    .btn {
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      white-space: nowrap;
    }
    .btn-question {
      background: #e0f0ff;
      border-color: #66a3ff;
    }
    .btn-answer {
      background: #ffe0f0;
      border-color: #ff66a3;
    }
    .btn-talk {
      background: #f0ffe0;
      border-color: #a3d966;
    }
    small {
      color: #666;
    }

    /* ===== ã‚¹ãƒãƒ›å‘ã‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå¹…600pxä»¥ä¸‹ï¼‰ ===== */
    @media (max-width: 600px) {
      body {
        padding: 6px;
        margin: 0 auto;
        font-size: 14px;
      }
      h1 {
        font-size: 1.3rem;
        margin: 4px 0 8px;
      }
      #room-info,
      #name-area {
        font-size: 0.8rem;
        padding: 6px;
        margin-bottom: 8px;
      }
      #log {
        height: 55vh;  /* ç”»é¢é«˜ã•ã®åŠåˆ†ã¡ã‚‡ã£ã¨ã‚’ãƒãƒ£ãƒƒãƒˆã« */
        font-size: 0.9rem;
      }
      #form {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        position: sticky;
        bottom: 0;
        background: #ffffff; /* â† ã“ã“ã‚‚ç™½ã« */
        padding-top: 4px;
      }
      #input {
        width: 100%;
      }
      .btn {
        width: 100%;
        text-align: center;
        font-size: 0.95rem;
        padding: 10px 12px;
      }
      #log-toolbar {
        align-items: flex-end;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <h1>Yes/No ã‚¯ã‚¤ã‚º</h1>

  <div id="room-info">
    <div>éƒ¨å±‹ID: <strong id="room-id"></strong></div>
    <div>
      ã“ã®URLã‚’å‹ã ã¡ã«é€ã‚‹ã¨ã€åŒã˜éƒ¨å±‹ã§ä¸€ç·’ã«ãƒ—ãƒ¬ã‚¤ã§ãã¾ã™ï¼š<br />
      <span id="room-url"></span><br />
      <small>ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§URLã‚’ã‚³ãƒ”ãƒ¼ï¼‰</small>
    </div>
  </div>

  <div id="name-area">
    <div>
      ã‚ãªãŸã®åå‰:
      <input id="name-input" type="text" placeholder="ä¾‹: å¤ªéƒ" />
      <button id="name-save-btn" type="button" class="btn">åå‰ã‚’ä¿å­˜</button>
    </div>
    <small>â€» åŒã˜éƒ¨å±‹ã®å‚åŠ è€…ã«ã¯ã€ã“ã“ã§è¨­å®šã—ãŸåå‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</small>
  </div>

  <div id="log-toolbar">
    <button id="copy-log-btn" type="button" class="btn btn-copy">
      ãƒãƒ£ãƒƒãƒˆã‚’å…¨ã‚³ãƒ”ãƒ¼
    </button>
    <small>ï¼ˆå…¨ã¦ã®ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼‰</small>
  </div>

  <div id="log"></div>

  <form id="form">
    <input
      id="input"
      type="text"
      placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆè³ªå•ãƒ»è§£ç­”ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ç›¸è«‡ãªã©ï¼‰"
      autocomplete="off"
    />
    <button type="submit" class="btn btn-question" id="ask-btn">è³ªå•ã‚’é€ä¿¡</button>
    <button type="button" class="btn btn-answer" id="answer-btn">è§£ç­”ã‚’é€ä¿¡</button>
    <button type="button" class="btn btn-talk" id="talk-btn">ç›¸è«‡ãƒãƒ£ãƒƒãƒˆ</button>
  </form>

  <script>
    const log = document.getElementById("log");
    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const askBtn = document.getElementById("ask-btn");
    const answerBtn = document.getElementById("answer-btn");
    const copyLogBtn = document.getElementById("copy-log-btn");
    const talkBtn = document.getElementById("talk-btn");

    const roomIdSpan = document.getElementById("room-id");
    const roomUrlSpan = document.getElementById("room-url");

    const nameInput = document.getElementById("name-input");
    const nameSaveBtn = document.getElementById("name-save-btn");

    // ==== éƒ¨å±‹IDï¼ˆURLã® ?room=xxxx ã‚’åˆ©ç”¨ï¼‰ ====
    function getRoomId() {
      const url = new URL(window.location.href);
      let room = url.searchParams.get("room");
      if (!room) {
        room = Math.random().toString(36).slice(2, 8);
        url.searchParams.set("room", room);
        window.history.replaceState({}, "", url);
      }
      return room;
    }

    const roomId = getRoomId();
    roomIdSpan.textContent = roomId;
    roomUrlSpan.textContent = window.location.href;

    roomUrlSpan.addEventListener("click", () => {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(window.location.href)
          .then(() => {
            alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
          })
          .catch(() => {
            alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
          });
      }
    });

    // åŒã˜éƒ¨å±‹IDã‚’ sessionId ã¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«æ¸¡ã™
    let sessionId = "room-" + roomId;

    // ==== ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ç®¡ç† ====
    const LOCAL_STORAGE_KEY = "yesno-quiz-username";

    function loadMyName() {
      const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (saved) return saved;
      // ãªã‘ã‚Œã°ä»®ã®åå‰ã‚’ã¤ãã‚‹
      const temp = "ã‚²ã‚¹ãƒˆ" + Math.floor(Math.random() * 1000);
      localStorage.setItem(LOCAL_STORAGE_KEY, temp);
      return temp;
    }

    let myName = loadMyName();
    nameInput.value = myName;

    nameSaveBtn.addEventListener("click", () => {
      const val = nameInput.value.trim();
      if (!val) {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      myName = val;
      localStorage.setItem(LOCAL_STORAGE_KEY, myName);
      alert("åå‰ã‚’ã€Œ" + myName + "ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚");
    });

    // ==== åˆæœŸã®GPTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå›ºå®šæ–‡è¨€ï¼‰ ====
    function renderInitialThemeMessage() {
      log.innerHTML = "";
      const div = document.createElement("div");
      div.classList.add("msg", "msg-bot");
      div.textContent =
        "ã©ã®ãƒ†ãƒ¼ãƒã§éŠã³ã¾ã™ã‹ï¼Ÿ\n\n" +
        "1: å›½é€£åŠ ç›Ÿå›½ã®å›½å\n" +
        "2: æ—¥æœ¬ã®G1å‡ºèµ°çµŒé¨“ãŒã‚ã‚‹ç«¶èµ°é¦¬å\n" +
        "3: æ—¥æœ¬ã®ä¸­å¤®é‡è³å‡ºèµ°çµŒé¨“ãŒã‚ã‚‹ç«¶èµ°é¦¬å\n\n" +
        "éŠã³ãŸã„ãƒ†ãƒ¼ãƒã®ç•ªå·ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚";
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    // ==== GPTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•´å½¢ï¼ˆMVP / POINT ã‚’ã‚¢ã‚¤ã‚³ãƒ³é¢¨ã«ï¼‰ ====
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function formatBotMessage(text) {
      const lines = text.split(/\r?\n/);
      const htmlLines = lines
        .map((line) => {
          const raw = line.trim();
          if (!raw) return "";
          if (/^MVP[:ï¼š]/.test(raw)) {
            const body = escapeHtml(raw.replace(/^MVP[:ï¼š]\s*/, ""));
            return (
              '<div class="bot-tag-line">' +
              '<span class="bot-tag bot-tag-mvp">ğŸ† MVP</span>' +
              '<span class="bot-tag-text">' +
              body +
              "</span></div>"
            );
          }
          if (/^POINT[:ï¼š]/.test(raw)) {
            const body = escapeHtml(raw.replace(/^POINT[:ï¼š]\s*/, ""));
            return (
              '<div class="bot-tag-line">' +
              '<span class="bot-tag bot-tag-point">ğŸ’¡ POINT</span>' +
              '<span class="bot-tag-text">' +
              body +
              "</span></div>"
            );
          }
          return '<div class="bot-line">' + escapeHtml(raw) + "</div>";
        })
        .filter(Boolean);
      return htmlLines.join("");
    }

    // ==== ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®æç”» ====
    function renderLog(messages) {
      log.innerHTML = "";
      messages.forEach((msg) => {
        const div = document.createElement("div");
        div.classList.add("msg");

        if (msg.type === "gpt") {
          // GPTã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          div.classList.add("msg-bot");
          div.innerHTML =
            '<div class="bot-name">GPT</div>' +
            '<div class="bot-body">' +
            formatBotMessage(msg.text) +
            "</div>";
        } else if (msg.type === "user") {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè³ªå•ãƒ»å›ç­”ãƒ»ç›¸è«‡ãƒãƒ£ãƒƒãƒˆã‚’å«ã‚€ï¼‰
          const isMe = msg.name === myName;
          const displayName = isMe ? "ã‚ãªãŸ" : "#" + msg.name;

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰²ä»˜ã‘ï¼ˆè‡ªåˆ†: é’ / ä»–äºº: ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
          if (isMe) {
            div.classList.add("msg-me");
          } else {
            div.classList.add("msg-other");
          }

          // ç›¸è«‡ãƒãƒ£ãƒƒãƒˆãªã‚‰ [ç›¸è«‡] ãƒ©ãƒ™ãƒ«ã¨è£…é£¾ã‚’è¿½åŠ 
          let label = "";
          if (msg.kind === "free") {
            label = " [ç›¸è«‡]";
            div.classList.add("msg-free");
          }

          div.textContent = `${displayName}${label}: ${msg.text}`;
        } else {
          // ãã®ä»–ï¼ˆå¿µã®ãŸã‚ï¼‰
          div.textContent = msg.text;
        }

        log.appendChild(div);
      });
      log.scrollTop = log.scrollHeight;
    }

    async function fetchLogAndRender() {
      try {
        const res = await fetch(
          "/api/log?sessionId=" + encodeURIComponent(sessionId)
        );
        const data = await res.json();
        if (data.sessionId) {
          sessionId = data.sessionId;
        }
        if (Array.isArray(data.messages)) {
          if (data.messages.length === 0) {
            // ã¾ã èª°ã‚‚ç™ºè¨€ã—ã¦ã„ãªã„éƒ¨å±‹ãªã‚‰ã€å›ºå®šã®ãƒ†ãƒ¼ãƒæ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            renderInitialThemeMessage();
          } else {
            renderLog(data.messages);
          }
        }
      } catch (err) {
        console.error("ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    // ==== ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ ====
    async function sendToServer(message, kind) {
      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId,
            message,
            name: myName,
            kind: kind || "question",
          }),
        });

        const data = await res.json();
        if (data.error) {
          const div = document.createElement("div");
          div.classList.add("msg", "msg-bot");
          div.textContent = "ã‚¨ãƒ©ãƒ¼: " + data.error;
          log.appendChild(div);
          log.scrollTop = log.scrollHeight;
        } else {
          if (data.sessionId) {
            sessionId = data.sessionId;
          }
          // é€ä¿¡å¾Œã€æœ€æ–°ãƒ­ã‚°ã‚’å–å¾—ã—ã¦æç”»
          await fetchLogAndRender();
        }
      } catch (err) {
        console.error(err);
        const div = document.createElement("div");
        div.classList.add("msg", "msg-bot");
        div.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆEnterï¼‰ã§é€ä¿¡ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œè³ªå•ã€
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "question");
    });

    // ãƒœã‚¿ãƒ³: è³ªå•ã‚’é€ä¿¡
    askBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "question");
    });

    // ãƒœã‚¿ãƒ³: å›ç­”ã‚’é€ä¿¡
    answerBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "answer");
    });

    // ãƒœã‚¿ãƒ³: ç›¸è«‡ãƒãƒ£ãƒƒãƒˆï¼ˆGPTã«ã¯é€ã‚‰ãªã„ï¼‰
    talkBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "free"); // kind = "free" ã§ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹
    });

    // ==== ãƒãƒ£ãƒƒãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ ====
    copyLogBtn.addEventListener("click", () => {
      const text = log.innerText || "";
      if (!text.trim()) {
        alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆã‚‹å ´åˆ
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("ãƒãƒ£ãƒƒãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
          })
          .catch(() => {
            alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          });
      } else {
        // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ã®ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const temp = document.createElement("textarea");
        temp.value = text;
        temp.style.position = "fixed";
        temp.style.left = "-9999px";
        document.body.appendChild(temp);
        temp.select();
        try {
          document.execCommand("copy");
          alert("ãƒãƒ£ãƒƒãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
        } catch (e) {
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
        }
        document.body.removeChild(temp);
      }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener("load", async () => {
      // ã¾ãšã¯ç¾åœ¨ã®éƒ¨å±‹ã®ãƒ­ã‚°ã‚’ç¢ºèª
      await fetchLogAndRender();

      // ãã®å¾Œã€1ç§’ã”ã¨ã«ãƒ­ã‚°ã‚’æ›´æ–°ï¼ˆä»–ã®äººã®ç™ºè¨€ã‚‚åæ˜ ã•ã‚Œã‚‹ï¼‰
      setInterval(fetchLogAndRender, 1000);
    });
  </script>
</body>
</html>
