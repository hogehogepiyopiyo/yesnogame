<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yes/No ã‚¯ã‚¤ã‚º</title>
  <style>
  html,
  body {
    height: 100%;
  }

  body {
    font-family: system-ui, sans-serif;
    max-width: 800px;
    margin: 20px auto;
    padding: 0 10px;
    background: #ffffff;
  }

  h1 {
    text-align: center;
    margin: 6px 0 10px;
  }

  /* PC ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ #page ã¯æ™®é€šã®ãƒ–ãƒ­ãƒƒã‚¯è¦ç´  */
  #page {
    /* ã‚¹ãƒãƒ›ã§ã®ã¿ flex ã«ã™ã‚‹ï¼ˆå¾Œè¿°ã® @media å†…ã§ä¸Šæ›¸ãï¼‰ */
  }

  /* ===== ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆè¨­å®šï¼æ“ä½œæ–¹æ³•ï¼‰ ===== */
  #mobile-menus {
    margin-bottom: 8px;
  }

  #settings-details,
  #howto-details {
    margin-bottom: 6px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #fff;
  }

  #settings-summary,
  #howto-details > summary {
    padding: 6px 8px;
    cursor: pointer;
    font-size: 0.9rem;
    list-style: none;
  }

  #settings-summary::-webkit-details-marker,
  #howto-details > summary::-webkit-details-marker {
    display: none; /* ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® > ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¶ˆã™ */
  }

  #settings-body,
  #howto-body {
    padding: 4px 8px 8px;
    border-top: 1px solid #eee;
  }

  /* ===== éƒ¨å±‹æƒ…å ± ===== */
  #room-info {
    margin-bottom: 10px;
    padding: 8px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
    background: #fff;
    border-radius: 6px;
  }

  #room-url {
    cursor: pointer;
    text-decoration: underline;
    word-break: break-all;
  }

  /* ===== åå‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå…¥åŠ›ï¼‹ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ï¼‰ ===== */
  #name-area {
    margin: 10px 0;
    padding: 8px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
    background: #fff;
    border-radius: 6px;
  }

  #name-area-main {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  #name-input {
    padding: 4px;
    font-size: 1rem;
    width: 200px;
    max-width: 100%;
    flex: 1;
    min-width: 0;
  }

  #name-save-btn {
    white-space: nowrap;
  }

  /* ===== ãƒãƒ£ãƒƒãƒˆãƒ­ã‚° ===== */

  /* PC ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯é«˜ã• 400px ã®ãƒãƒ£ãƒƒãƒˆé ˜åŸŸ */
  #log {
    border: 1px solid #ccc;
    padding: 10px;
    height: 400px;
    overflow-y: auto;
    background: #fafafa;
    margin-bottom: 10px;
    white-space: pre-wrap;
    border-radius: 6px;
  }

  #log-toolbar {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    margin-bottom: 4px;
    gap: 4px;
    font-size: 0.85rem;
  }

  .btn-copy {
    background: #f7f4ff;
    border-color: #c4b1ff;
    font-size: 0.8rem;
    padding: 4px 8px;
  }

  /* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
  .msg {
    margin-bottom: 6px;
    font-size: 0.95rem;
  }

  .msg-me {
    color: #0044aa; /* è‡ªåˆ†ï¼ˆé’ç³»ï¼‰ */
  }

  .msg-other {
    color: #aa6600; /* ä»–äººï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰ */
  }

  .msg-free {
    background: #fff8e1;           /* è–„ã„ã‚¯ãƒªãƒ¼ãƒ è‰²ã®èƒŒæ™¯ */
    border-left: 3px solid #ffb300;/* å·¦ã«é»„è‰²ã„ç·š */
    padding: 2px 4px;
    border-radius: 3px;
  }

  .msg-bot {
    color: #004422;
    background: #e5f5e5;
    border-left: 4px solid #66aa66;
    padding: 6px 8px;
    border-radius: 4px;
  }

  .bot-name {
    font-weight: bold;
    margin-bottom: 4px;
  }

  .bot-body {
    font-size: 0.95rem;
  }

  .bot-line {
    margin: 1px 0;
  }

  .bot-tag-line {
    margin: 2px 0;
  }

  .bot-tag {
    display: inline-block;
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 999px;
    margin-right: 6px;
    background: #ffffff;
    border: 1px solid #cccccc;
    vertical-align: middle;
  }

  .bot-tag-mvp {
    border-color: #e6a700;
  }

  .bot-tag-point {
    border-color: #0088cc;
  }

  .bot-tag-text {
    vertical-align: middle;
  }

  /* ===== å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ãƒœã‚¿ãƒ³ ===== */
  #form {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 4px;
  }

  #input {
    flex: 1;
    padding: 8px;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    background: #fff;
  }

  .btn {
    padding: 8px 12px;
    font-size: 0.9rem;
    cursor: pointer;
    border-radius: 4px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    white-space: nowrap;
    color: #333;
    -webkit-appearance: none;
    appearance: none;
  }

  .btn-question {
    background: #e0f0ff;
    border-color: #66a3ff;
  }

  .btn-answer {
    background: #ffe0f0;
    border-color: #ff66a3;
  }

  .btn-talk {
    background: #f0ffe0;
    border-color: #a3d966;
  }

  /* è³ªå•ï¼è§£ç­”ï¼ç›¸è«‡ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹è¡Œ */
  #button-row {
    display: flex;
    gap: 4px;
  }

  #button-row .btn {
    flex: 1;
    width: auto; /* flex ãƒ™ãƒ¼ã‚¹ã«ä»»ã›ã‚‹ */
  }

  small {
    color: #666;
  }

  /* ==== ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ ==== */
  #error-banner {
    display: none;
    margin: 8px 0;
    padding: 8px 10px;
    border-radius: 4px;
    background: #ffe6e6;
    border: 1px solid #ff5c5c;
    color: #b30000;
    font-size: 0.9rem;
  }

  #error-banner strong {
    margin-right: 6px;
  }

  /* ===== ã‚¹ãƒãƒ›å‘ã‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå¹…600pxä»¥ä¸‹ï¼‰ ===== */
  @media (max-width: 600px) {
    body {
      padding: 4px 6px;
      margin: 0 auto;
      font-size: 14px;
    }

    h1 {
      font-size: 1.2rem;
      margin: 4px 0 4px;
    }

    #room-info,
    #name-area {
      font-size: 0.8rem;
      padding: 4px 6px;
      margin-bottom: 6px;
    }

    /* ã‚¹ãƒãƒ›ã®ã¨ãã ã‘ã€ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ç¸¦æ–¹å‘ flex ã«ã™ã‚‹ */
    #page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ­ã‚°ã¯ã€Œä½™ã£ãŸé«˜ã•å…¨éƒ¨ã€ã‚’ä½¿ã†ã€‚PC ã® height:400px ã‚’ä¸Šæ›¸ã */
    #log {
      flex: 1;
      min-height: 0;
      height: auto;
      font-size: 0.9rem;
    }

    #form {
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      position: sticky;
      bottom: 0;
      background: #ffffff;
      padding: 4px 4px 6px;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.06); /* ä¸Šå´ã«ã”ãè–„ã„å½± */
    }

    /* ã‚¹ãƒãƒ›ã§ã¯ã€Œå…¥åŠ›æ¬„ã®ä¸‹ã«æ¨ª3ã¤ã€ */
    #form .btn {
      flex: 1;
    }

    #input {
      width: 100%;
    }

    .btn {
      width: 100%;        /* 1ã‚«ãƒ©ãƒ é…ç½®æ™‚ç”¨ï¼ˆbutton-row ã®ä¸­ã§ã¯ width:auto ã«ä¸Šæ›¸ãï¼‰ */
      text-align: center;
      font-size: 0.9rem;
      padding: 8px 12px;
    }

    #button-row .btn {
      font-size: 0.9rem;
      padding: 8px 4px;
      width: auto;        /* æ¨ª3ã¤ã§å‡ç­‰ */
    }

    #log-toolbar {
      align-items: flex-end;
      font-size: 0.8rem;
    }

    #log-toolbar small {
      display: none;
    }

    /* éƒ¨å±‹IDã¨åå‰ãƒ–ãƒ­ãƒƒã‚¯ã®èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆã¯ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤º */
    #room-info small,
    #name-area small {
      display: none;
    }
  }
  </style>
</head>


<body>
  <h1>Yes/No ã‚¯ã‚¤ã‚º</h1>


  <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ -->
  <div id="error-banner">
    <strong>ã‚¨ãƒ©ãƒ¼</strong><span id="error-message"></span>
  </div>


  <!-- ã“ã“ã‹ã‚‰pageã§å›²ã‚€ -->
  <div id="page">


  <!-- ã‚¹ãƒãƒ›ç”¨ ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆPCã§ã¯è¦‹ãŸç›®ã ã‘å¤‰ãˆã‚‹æƒ³å®šï¼‰ -->
  <div id="mobile-menus">
    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <details id="settings-details">
      <summary id="settings-summary">
        éƒ¨å±‹ID: <strong><span id="summary-room-id">----</span></strong>
        / åå‰: <strong><span id="summary-name">----</span></strong>
        / è¨­å®š <strong>â–¼</strong>
      </summary>

      <div id="settings-body">


  <div id="room-info">
    <div>éƒ¨å±‹ID: <strong id="room-id"></strong></div>
    <div>
      URLã‚’å…±æœ‰ã™ã‚‹ã¨åŒã˜éƒ¨å±‹ã§ä¸€ç·’ã«ãƒ—ãƒ¬ã‚¤ã§ãã¾ã™ï¼š<br />
      <span id="room-url"></span><br />
      <small>ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§URLã‚’ã‚³ãƒ”ãƒ¼ï¼‰</small>
    </div>
  </div>


  <div id="name-area">
    <div id="name-area-main">
      <span>åå‰:</span>
      <input id="name-input" type="text" placeholder="ä¾‹: å¤ªéƒ" />
      <button id="name-save-btn" type="button" class="btn">ä¿å­˜</button>
    </div>
    <small>â€» åŒã˜éƒ¨å±‹ã®å‚åŠ è€…ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</small>
  </div>

  <div id="log-toolbar">
    <button id="copy-log-btn" type="button" class="btn btn-copy">
      ãƒãƒ£ãƒƒãƒˆã‚’å…¨ã‚³ãƒ”ãƒ¼
    </button>
    <small>ï¼ˆãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼‰</small>
  </div>

      </div>
    </details>

    <!-- æ“ä½œæ–¹æ³•ãƒ‘ãƒãƒ« -->
    <details id="howto-details">
      <summary>æ“ä½œæ–¹æ³•ã¨ãƒ’ãƒ³ãƒˆ <strong>â–¼</strong></summary>
      <div id="howto-body">
        <p><ul>
<li>éŠã¶ãƒ†ãƒ¼ãƒã®ç•ªå·ã‚’é€ä¿¡ã™ã‚‹ã¨ã‚¹ã‚¿ãƒ¼ãƒˆ</li>
<li>ã€Œè³ªå•ã€ãƒœã‚¿ãƒ³ï¼šã¯ã„/ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’é€ä¿¡</li>
<li>ã€Œè§£ç­”ã€ãƒœã‚¿ãƒ³ï¼šæ­£è§£ã ã¨æ€ã†å˜èªã‚’é€ä¿¡</li>
<li>ã€Œç›¸è«‡ã€ãƒœã‚¿ãƒ³ï¼šåŒã˜éƒ¨å±‹ã®å‚åŠ è€…ã ã‘ã§ãƒãƒ£ãƒƒãƒˆã—ãŸã„ã¨ãã¯ã€Œç›¸è«‡ã€ãƒœã‚¿ãƒ³ã§é€ä¿¡<br>
ï¼ˆç›¸è«‡ãƒœã‚¿ãƒ³ã§é€ä¿¡ã™ã‚‹ã¨ã€GPTã¯ãã®å†…å®¹ã‚’ç„¡è¦–ã—ã¾ã™ï¼‰</li>
        <li>MVP / POINTï¼šGPTãŒç‰¹ã«è‰¯ã‹ã£ãŸè³ªå•ã‚„ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¿ã‚°ä»˜ãã§è¡¨ç¤ºã—ã¾ã™ã€‚</li>

</p>
        <p></p>
        <p><strong>â–¼ AIã«è³ªå•ã™ã‚‹ã¨ãã®ãƒ’ãƒ³ãƒˆ</strong></p>
<p>AIã®ãƒ¢ãƒ‡ãƒ«ã¯ã€â€ <strong>llama-3.3-70b-versatile</strong> â€ã§ã™ã€‚ã ã„ã¶ã†ã£ã‹ã‚Šã•ã‚“ã§ã™ã€‚<br>ã‚ˆãã†ãã‚’ã¤ã„ã¡ã‚ƒã†ã®ã§ã€è³ªå•ã™ã‚‹ã¨ãã¯æ°—ã‚’é£ã£ã¦ã‚ã’ã¦ã­ã€‚</p>
<p>è³ªå•æ–‡ã®ã‚³ãƒ„ï¼ˆæ¤œè¨¼ä¸­ï¼‰
<ul>
<li>è³ªå•ãƒ»å›ç­”ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ£ãƒƒãƒˆã®é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æ­£ã—ãä½¿ã†</li>
<li>æ–‡æœ«ã‚’ã€Œï½ã§ã™ã‹ï¼Ÿã€ã€Œï½ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ã«çµ±ä¸€<br>ï¼ˆã€Œï½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã€ã¿ãŸã„ãªå¦å®šç–‘å•æ–‡ã¯è‹¦æ‰‹ï¼‰</li>
<li>ãªã‚‹ã¹ãæ­£å¼åç§°ã‚’ç”¨ã„ã‚‹<br>ï¼ˆä¿—ç§°ã‚„ç•¥èªã¯èª¤è§£ã•ã‚ŒãŸã‚Šç†è§£ã§ããªã„ã‹ã‚‚ï¼‰</li>
<li>æ›–æ˜§ãªè¨€è‘‰ã‚„ä¸»è¦³çš„ãªè¡¨ç¾ã‚’é¿ã‘ã‚‹<br>ï¼ˆã€Œæœ€è¿‘ã€ã€ŒãŸã¾ã«ã€ã¿ãŸã„ãªè¨€è‘‰ã¯è§£é‡ˆãŒãƒ–ãƒ¬ã‚„ã™ã„ï¼‰</li>
<li>ä¸€åº¦ã«è³ªå•ã™ã‚‹å†…å®¹ã¯1ã¤ã ã‘ã«ã™ã‚‹<br>ï¼ˆæ¡ä»¶ã‚’ç´°åˆ†åŒ–ã™ã‚‹ã¨çŸ›ç›¾ãŒèµ·ã“ã‚Šã«ãã„ï¼‰</li>
</ul>

</p>

      </div>
    </details>
  </div>



  <div id="log"></div>

  <form id="form">
    <input
      id="input"
      type="text"
      placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆè³ªå•ãƒ»è§£ç­”ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ç›¸è«‡ãªã©ï¼‰"
      autocomplete="off"
    />
    <div id="button-row">
    <button type="submit" class="btn btn-question" id="ask-btn">è³ªå•</button>
    <button type="button" class="btn btn-answer" id="answer-btn">è§£ç­”</button>
    <button type="button" class="btn btn-talk" id="talk-btn">ç›¸è«‡</button>
    </div>
  </form>


  </div>
  <!-- ã“ã“ã¾ã§ã‚’ page ã§å›²ã‚€ -->

  <script>
    const log = document.getElementById("log");
    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const askBtn = document.getElementById("ask-btn");
    const answerBtn = document.getElementById("answer-btn");
    const copyLogBtn = document.getElementById("copy-log-btn");
    const talkBtn = document.getElementById("talk-btn");

    const errorBanner = document.getElementById("error-banner");
    const errorMessageSpan = document.getElementById("error-message");

    const roomIdSpan = document.getElementById("room-id");
    const roomUrlSpan = document.getElementById("room-url");

    const nameInput = document.getElementById("name-input");
    const nameSaveBtn = document.getElementById("name-save-btn");

    // ==== éƒ¨å±‹IDï¼ˆURLã® ?room=xxxx ã‚’åˆ©ç”¨ï¼‰ ====
    function getRoomId() {
      const url = new URL(window.location.href);
      let room = url.searchParams.get("room");
      if (!room) {
        room = Math.random().toString(36).slice(2, 8);
        url.searchParams.set("room", room);
        window.history.replaceState({}, "", url);
      }
      return room;
    }

    const roomId = getRoomId();
    roomIdSpan.textContent = roomId;
    roomUrlSpan.textContent = window.location.href;

    roomUrlSpan.addEventListener("click", () => {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(window.location.href)
          .then(() => {
            alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
          })
          .catch(() => {
            alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
          });
      }
    });

    // åŒã˜éƒ¨å±‹IDã‚’ sessionId ã¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«æ¸¡ã™
    let sessionId = "room-" + roomId;

    // ==== ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ç®¡ç† ====
    const LOCAL_STORAGE_KEY = "yesno-quiz-username";

    function loadMyName() {
      const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (saved) return saved;
      // ãªã‘ã‚Œã°ä»®ã®åå‰ã‚’ã¤ãã‚‹
      const temp = "ã‚²ã‚¹ãƒˆ" + Math.floor(Math.random() * 1000);
      localStorage.setItem(LOCAL_STORAGE_KEY, temp);
      return temp;
    }

    let myName = loadMyName();
    nameInput.value = myName;
    const settingsDetails = document.getElementById("settings-details");
    const howtoDetails = document.getElementById("howto-details");
    const summaryRoomSpan = document.getElementById("summary-room-id");
    const summaryNameSpan = document.getElementById("summary-name");

    // éƒ¨å±‹IDã‚’ summary ã«åæ˜ 
    summaryRoomSpan.textContent = roomId;

    // åå‰ã‚‚åˆæœŸå€¤ã‚’åæ˜ 
    summaryNameSpan.textContent = myName;


// ã“ã“ã‚ˆã‚Šå¾Œã‚ã§ nameSaveBtn ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã™ã‚‹
    nameSaveBtn.addEventListener("click", () => {
      const val = nameInput.value.trim();
      if (!val) {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      myName = val;
      localStorage.setItem(LOCAL_STORAGE_KEY, myName);
      alert("åå‰ã‚’ã€Œ" + myName + "ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚");

      // è¿½åŠ ï¼šsummary è¡¨ç¤ºã‚‚æ›´æ–°
      summaryNameSpan.textContent = myName;

    });


// ç”»é¢å¹…ã«é–¢ä¿‚ãªãã€åˆæœŸçŠ¶æ…‹ã¯ä¸¡æ–¹ã¨ã‚‚é–‰ã˜ã‚‹
function setupDetailsOpenState() {
  settingsDetails.open = false;
  howtoDetails.open = false;
}

    setupDetailsOpenState();




    // ==== ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º/éè¡¨ç¤º ==== 
    function showError(message) {
      if (!message) return;
      errorMessageSpan.textContent = message;
      errorBanner.style.display = "block";
    }

    function clearError() {
      errorBanner.style.display = "none";
      errorMessageSpan.textContent = "";
    }

    // ==== åˆæœŸã®GPTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå›ºå®šæ–‡è¨€ï¼‰ ====
    function renderInitialThemeMessage() {
      log.innerHTML = "";
      const div = document.createElement("div");
      div.classList.add("msg", "msg-bot");
      div.textContent =
        "ã©ã®ãƒ†ãƒ¼ãƒã§éŠã³ã¾ã™ã‹ï¼Ÿ\n\n" +
        "1: å›½é€£åŠ ç›Ÿå›½ã®å›½å\n" +
        "2: æ—¥æœ¬ã®G1å‡ºèµ°çµŒé¨“ãŒã‚ã‚‹ç«¶èµ°é¦¬å\n" +
        "3: æ—¥æœ¬ã®ä¸­å¤®é‡è³å‡ºèµ°çµŒé¨“ãŒã‚ã‚‹ç«¶èµ°é¦¬å\n\n" +
        "éŠã³ãŸã„ãƒ†ãƒ¼ãƒã®ç•ªå·ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚";
      log.appendChild(div);
      // åˆå›ã ã‘ã¯ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      log.scrollTop = log.scrollHeight;
    }

    // ==== GPTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•´å½¢ï¼ˆMVP / POINT ã‚’ã‚¢ã‚¤ã‚³ãƒ³é¢¨ã«ï¼‰ ====
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function formatBotMessage(text) {
      const lines = text.split(/\r?\n/);
      const htmlLines = lines
        .map((line) => {
          const raw = line.trim();
          if (!raw) return "";
          if (/^MVP[:ï¼š]/.test(raw)) {
            const body = escapeHtml(raw.replace(/^MVP[:ï¼š]\s*/, ""));
            return (
              '<div class="bot-tag-line">' +
              '<span class="bot-tag bot-tag-mvp">ğŸ† MVP</span>' +
              '<span class="bot-tag-text">' +
              body +
              "</span></div>"
            );
          }
          if (/^POINT[:ï¼š]/.test(raw)) {
            const body = escapeHtml(raw.replace(/^POINT[:ï¼š]\s*/, ""));
            return (
              '<div class="bot-tag-line">' +
              '<span class="bot-tag bot-tag-point">ğŸ’¡ POINT</span>' +
              '<span class="bot-tag-text">' +
              body +
              "</span></div>"
            );
          }
          return '<div class="bot-line">' + escapeHtml(raw) + "</div>";
        })
        .filter(Boolean);
      return htmlLines.join("");
    }

    // ==== ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®æç”» ====
    function renderLog(messages) {
      // ã„ã¾ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®ã‚ãŸã‚Šã‚’è¦‹ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const prevScrollTop = log.scrollTop;
      const prevScrollHeight = log.scrollHeight;
      const isAtBottom =
        prevScrollHeight - (prevScrollTop + log.clientHeight) < 10;

      log.innerHTML = "";
      messages.forEach((msg) => {
        const div = document.createElement("div");
        div.classList.add("msg");

        if (msg.type === "gpt") {
          // GPTã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          div.classList.add("msg-bot");
          div.innerHTML =
            '<div class="bot-name">GPT</div>' +
            '<div class="bot-body">' +
            formatBotMessage(msg.text) +
            "</div>";
        } else if (msg.type === "user") {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè³ªå•ãƒ»å›ç­”ãƒ»ç›¸è«‡ãƒãƒ£ãƒƒãƒˆã‚’å«ã‚€ï¼‰
          const isMe = msg.name === myName;
          const displayName = isMe ? "ã‚ãªãŸ" : "#" + msg.name;

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰²ä»˜ã‘ï¼ˆè‡ªåˆ†: é’ / ä»–äºº: ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
          if (isMe) {
            div.classList.add("msg-me");
          } else {
            div.classList.add("msg-other");
          }

          // ç›¸è«‡ãƒãƒ£ãƒƒãƒˆãªã‚‰ [ç›¸è«‡] ãƒ©ãƒ™ãƒ«ã¨è£…é£¾ã‚’è¿½åŠ 
          let label = "";
          if (msg.kind === "free") {
            label = " [ç›¸è«‡]";
            div.classList.add("msg-free");
          }

          div.textContent = `${displayName}${label}: ${msg.text}`;
        } else {
          // ãã®ä»–ï¼ˆå¿µã®ãŸã‚ï¼‰
          div.textContent = msg.text;
        }

        log.appendChild(div);
      });

      const newScrollHeight = log.scrollHeight;

      if (isAtBottom) {
        // ä¸€ç•ªä¸‹ã‚’è¦‹ã¦ã„ãŸå ´åˆã ã‘ã€è‡ªå‹•ã§æœ€ä¸‹éƒ¨ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        log.scrollTop = newScrollHeight;
      } else {
        // éå»ãƒ­ã‚°ã‚’è¦‹ã¦ã„ã‚‹å ´åˆã¯ã€ä½ç½®ã‚’ã§ãã‚‹ã ã‘ç¶­æŒ
        const delta = newScrollHeight - prevScrollHeight;
        log.scrollTop = prevScrollTop + delta;
      }
    }

    async function fetchLogAndRender() {
      try {
        const res = await fetch(
          "/api/log?sessionId=" + encodeURIComponent(sessionId)
        );
        const data = await res.json();
        if (data.sessionId) {
          sessionId = data.sessionId;
        }
        if (Array.isArray(data.messages)) {
          if (data.messages.length === 0) {
            // ã¾ã èª°ã‚‚ç™ºè¨€ã—ã¦ã„ãªã„éƒ¨å±‹ãªã‚‰ã€å›ºå®šã®ãƒ†ãƒ¼ãƒæ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            renderInitialThemeMessage();
          } else {
            renderLog(data.messages);
          }
        }
      } catch (err) {
        console.error("ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    // ==== ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ ====
    async function sendToServer(message, kind) {
      try {
        clearError(); // æ–°ã—ã„é€ä¿¡ã®ãŸã³ã«å‰å›ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¶ˆã™

        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId,
            message,
            name: myName,
            kind: kind || "question",
          }),
        });

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’ JSON ã¨ã—ã¦èª­ã¿ã«ã„ãï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–ã‚ŠãŸã„ã®ã§ï¼‰
        let data = {};
        try {
          data = await res.json();
        } catch (e) {
          // JSON ã§è¿”ã£ã¦ã“ãªã„å ´åˆã‚‚ã‚ã‚‹ã®ã§ã€ãã®ã¨ãã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¾ã¾
          console.error("JSON ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e);
        }

        // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        if (!res.ok) {
          // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒãƒˆã—ãŸã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å„ªå…ˆçš„ã«ä½¿ã†
          if (data && data.error === "rate_limit") {
            // ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showError(
              data.message ||
                "ç¾åœ¨ã€å¤–éƒ¨AIã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
            );
          } else if (data && data.message) {
            showError(data.message);
          } else {
            // æ±ç”¨çš„ãªã‚¨ãƒ©ãƒ¼
            showError("ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
          }
          return;
        }

        // ã“ã“ã«æ¥ã‚‹ã®ã¯ res.ok === true ã®ã¨ãï¼ˆ200ç•ªå°ï¼‰
        if (data.error) {
          // 200ã ã‘ã© error ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ç‰¹æ®Šã‚±ãƒ¼ã‚¹ã«å‚™ãˆã¦
          showError(data.message || "ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
          return;
        }

        // æ­£å¸¸ç³»ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³IDæ›´æ–° & ãƒ­ã‚°å†å–å¾—
        if (data.sessionId) {
          sessionId = data.sessionId;
        }

        await fetchLogAndRender();
      } catch (err) {
        console.error(err);
        showError("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }


    // ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆEnterï¼‰ã§é€ä¿¡ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œè³ªå•ã€
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "question");
    });

    // ãƒœã‚¿ãƒ³: è³ªå•ã‚’é€ä¿¡
    askBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "question");
    });

    // ãƒœã‚¿ãƒ³: å›ç­”ã‚’é€ä¿¡
    answerBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "answer");
    });

    // ãƒœã‚¿ãƒ³: ç›¸è«‡ãƒãƒ£ãƒƒãƒˆï¼ˆGPTã«ã¯é€ã‚‰ãªã„ï¼‰
    talkBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendToServer(text, "free"); // kind = "free" ã§ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹
    });

    // ==== ãƒãƒ£ãƒƒãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ ====
    copyLogBtn.addEventListener("click", () => {
      const text = log.innerText || "";
      if (!text.trim()) {
        alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆã‚‹å ´åˆ
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("ãƒãƒ£ãƒƒãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
          })
          .catch(() => {
            alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          });
      } else {
        // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ã®ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const temp = document.createElement("textarea");
        temp.value = text;
        temp.style.position = "fixed";
        temp.style.left = "-9999px";
        document.body.appendChild(temp);
        temp.select();
        try {
          document.execCommand("copy");
          alert("ãƒãƒ£ãƒƒãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
        } catch (e) {
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
        }
        document.body.removeChild(temp);
      }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener("load", async () => {
      // ã¾ãšã¯ç¾åœ¨ã®éƒ¨å±‹ã®ãƒ­ã‚°ã‚’ç¢ºèª
      await fetchLogAndRender();

      // ãã®å¾Œã€1ç§’ã”ã¨ã«ãƒ­ã‚°ã‚’æ›´æ–°ï¼ˆä»–ã®äººã®ç™ºè¨€ã‚‚åæ˜ ã•ã‚Œã‚‹ï¼‰
      setInterval(fetchLogAndRender, 1000);
    });
  </script>
</body>
</html>


